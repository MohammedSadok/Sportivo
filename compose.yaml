services:
  postgres:
    image: postgres:16
    container_name: app_postgres
    env_file: .env
    environment:
      POSTGRES_DB: ${DATABASE_NAME}
      POSTGRES_USER: ${DATABASE_USER}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
    ports:
      - "${DATABASE_PORT}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DATABASE_USER} -d ${DATABASE_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5

  keycloak_db:
    image: postgres:16
    container_name: keycloak_postgres
    env_file: .env
    labels:
      org.springframework.boot.ignore: "true"
    environment:
      POSTGRES_DB: ${KEYCLOAK_DATABASE_NAME}
      POSTGRES_USER: ${KEYCLOAK_DATABASE_USER}
      POSTGRES_PASSWORD: ${KEYCLOAK_DATABASE_PASSWORD}
    ports:
      - "${KEYCLOAK_DATABASE_PORT}:5432"
    volumes:
      - keycloak_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${KEYCLOAK_DATABASE_USER} -d ${KEYCLOAK_DATABASE_NAME}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  keycloak:
    image: quay.io/keycloak/keycloak:latest
    container_name: keycloak
    env_file: .env
    depends_on:
      keycloak_db:
        condition: service_healthy
    command: start --import-realm
    environment:
      KC_BOOTSTRAP_ADMIN_USERNAME: ${KEYCLOAK_USER}
      KC_BOOTSTRAP_ADMIN_PASSWORD: ${KEYCLOAK_PASSWORD}
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak_db:5432/${KEYCLOAK_DATABASE_NAME}
      KC_DB_USERNAME: ${KEYCLOAK_DATABASE_USER}
      KC_DB_PASSWORD: ${KEYCLOAK_DATABASE_PASSWORD}
      KC_HOSTNAME: ${KEYCLOAK_HOST}
      KC_HTTP_ENABLED: "true"
      KC_HTTP_PORT: ${KEYCLOAK_PORT}
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
      KC_LOG_LEVEL: info
      KC_PROXY_HEADERS: xforwarded
    ports:
      # Keycloak internally listens on KC_HTTP_PORT (8180), map it correctly
      - "${KEYCLOAK_PORT}:${KEYCLOAK_PORT}"
    volumes:
      - ./keycloak/realm:/opt/keycloak/data/import
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -f http://localhost:${KEYCLOAK_PORT}/health/ready || exit 1",
        ]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 60s

  # app:
  #   build: .
  #   container_name: sportivo_app
  #   env_file: .env
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     keycloak:
  #       condition: service_healthy
  #   environment:
  #     SPRING_PROFILES_ACTIVE: prod
  #     DATABASE_HOST: postgres        # container-to-container: use service name
  #     DATABASE_PORT: 5432
  #     # For container-to-container JWT validation, use keycloak service name
  #     SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://keycloak:${KEYCLOAK_PORT}/realms/${KEYCLOAK_REALM}
  #     SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://keycloak:${KEYCLOAK_PORT}/realms/${KEYCLOAK_REALM}/protocol/openid-connect/certs
  #     SERVER_FORWARD_HEADERS_STRATEGY: framework
  #   ports:
  #     - "${APP_PORT}:${APP_PORT}"

  mailhog:
    image: mailhog/mailhog
    container_name: mailhog
    ports:
      - "${MAILHOG_SMTP_PORT}:1025"
      - "${MAILHOG_UI_PORT}:8025"

  rustfs:
    image: rustfs/rustfs:latest
    container_name: rustfs
    env_file: .env
    environment:
      RUSTFS_ROOT_USER: ${RUSTFS_ROOT_USER}
      RUSTFS_ROOT_PASSWORD: ${RUSTFS_ROOT_PASSWORD}
    ports:
      - "${RUSTFS_API_PORT}:9000"
      - "${RUSTFS_CONSOLE_PORT}:9001"
    volumes:
      - rustfs_data:/data

volumes:
  postgres_data:
  keycloak_postgres_data:
  rustfs_data:
